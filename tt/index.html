<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Taskifactorio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">

    <style>
        :root {
            --main-color: #eeeeee;
            --main-color-hover: rgba(238, 238, 238, .1);
            --button-active-color: #ff4d4d;
            /* Red color for active button */
        }

        html,
        body {
            margin: 0;
        }

        body {
            background-color: #000000;
            color: var(--main-color);
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            /* justify-content: center; */
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
        }

        h2 {
            text-align: center;
        }

        .maxwidth {
            max-width: 800px;
            margin: auto;
            display: flex;
            flex-direction: column;
        }

        .task-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-row input[type="text"] {
            flex-grow: 1;
            height: 42px;
            padding: 4px 16px;
            background-color: #000000;
            color: var(--main-color);
            border: 1px solid var(--main-color);
            margin-right: 16px;
        }

        .task-row button {
            border: 1px solid var(--main-color);
            background-color: #000000;
            color: var(--main-color);
            padding: 8px 13px;
            border-radius: 0;
            margin-right: -1px;
        }

        .task-row .timer {
            min-width: 80px;
            text-align: center;
            margin-right: 16px;
        }

        .task-row .adjust-buttons {
            display: flex;
            align-items: center;
            margin-right: 16px;
        }

        .task-row .adjust-buttons button {
            margin-right: -1px;
            font-size: 1rem;
        }

        .task-row .decimal-time {
            font-size: 1rem;
            margin-left: auto;
        }

        .hidden {
            display: none !important;
        }

        .button-active {
            background-color: var(--button-active-color) !important;
            border-color: var(--button-active-color) !important;
            color: black !important;
        }

        .StartStop {
            width: 96px;
        }

        .brutalButton {
            border: 1px solid var(--main-color);
            background-color: #000000;
            color: var(--main-color);
            padding: .5rem 0;
            border-radius: 0;
            white-space: nowrap;
            /* Prevent text wrapping */
            min-width: 100px;
            /* Adjust based on your needs */
        }

        .brutalButton:hover {
            background-color: var(--main-color-hover);
            color: var(--main-color);
        }

        .brutalButton:last-child {
            margin-right: 0;
        }

        .brutal-list-group {
            flex-grow: 1;
            /* Make input take up available space */
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--main-color);
            background-color: #000000;
            color: var(--main-color);
            padding: .5rem .5rem;
            margin-right: -1px;
            /* Overlap borders */
            border-radius: 0;
            text-align: center;
        }

        .brutalInput {
            flex-grow: 1;
            /* Make input take up available space */
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--main-color);
            background-color: #000000;
            color: var(--main-color);
            padding: .5rem .5rem;
            margin-right: -1px;
            /* Overlap borders */
            border-radius: 0;
            text-align: center;
        }

        .form-control:focus {
            background-color: rgba(255, 255, 255, .1) !important;
            border-color: var(--main-color);
            outline: 0;
            box-shadow: none;
        }

        .brutalInput:focus {
            background-color: #333333;
            color: var(--main-color);
            /* Change text color to light gray when focused */
            outline: none;
            /* Remove the default focus outline */
        }

        .brutalInput::placeholder {
            /* Change the color of placeholders */
            color: var(--main-color);
        }

        .mt-neg-1 {
            margin-top: -1px;
            
        }
    </style>
</head>

<body>

    <div class="maxwidth container text-center my-5">
        <button id="addTaskButton" class="brutalButton">Add New Task</button>
        <button id="toggleTotalsButton" class="brutalButton mt-neg-1">Show Totals</button>
        <div id="tasks" class="mt-3"></div>
        <div id="totalsSum" class="mt-3 hidden"></div>
    </div>

    <script>
        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let showTotals = false;

        // const totalShiftSeconds = 8 * 60 * 60; // 9 hours in seconds

        function updateLocalStorage() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const mins = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const secs = (seconds % 60).toString().padStart(2, '0');
            return `${hrs}:${mins}:${secs}`;
        }

        function roundToQuarterHour(minutes) {
            return Math.round(minutes / 15) * 0.25;
        }

        function createTaskRow(task, index) {
            const taskRow = document.createElement('div');
            taskRow.className = 'task-row';

            const taskInput = document.createElement('input');
            taskInput.type = 'text';
            taskInput.value = task.name;
            taskInput.placeholder = 'Enter task name';
            taskInput.addEventListener('input', () => {
                tasks[index].name = taskInput.value;
                updateLocalStorage();
            });

            // Calculate the total time of all tasks
            const totalTaskTime = tasks.reduce((sum, task) => sum + task.time, 0);

            // Calculate the percentage of total time that the task represents
            const percentageOfTotal = totalTaskTime > 0 ? (task.time / totalTaskTime) * 200 : 0;

            // Apply a linear gradient to fill the input background based on task time
            taskInput.style.background = `linear-gradient(to right, #ffffff1f ${percentageOfTotal}%, #000000 0%)`;

            const timerDisplay = document.createElement('div');
            timerDisplay.className = 'timer';
            timerDisplay.textContent = formatTime(task.time);
            timerDisplay.id = `timer-${index}`;

            const startStopButton = document.createElement('button');
            startStopButton.textContent = task.isRunning ? 'Stop' : 'Start';
            startStopButton.classList.add('StartStop');
            startStopButton.classList.toggle('button-active', task.isRunning); // Make red when running
            startStopButton.addEventListener('click', () => {
                tasks.forEach((t, i) => {
                    if (i !== index) {
                        t.isRunning = false;
                    }
                });

                task.isRunning = !task.isRunning;
                if (task.isRunning) {
                    task.startTime = Date.now() - task.time * 1000;
                }
                updateLocalStorage();
                renderTasks();
            });

            // Trash Icon for Delete Button using Font Awesome
            const deleteButton = document.createElement('button');
            deleteButton.innerHTML = '<i class="fas fa-trash-alt"></i>'; // Trash icon
            deleteButton.addEventListener('click', () => {
                tasks.splice(index, 1);
                updateLocalStorage();
                renderTasks();
            });

            taskRow.appendChild(taskInput);
            taskRow.appendChild(timerDisplay);
            taskRow.appendChild(startStopButton);
            taskRow.appendChild(deleteButton);

            // Add adjust buttons and decimal time, initially hidden
            const adjustButtons = document.createElement('div');
            adjustButtons.className = `adjust-buttons ${showTotals ? '' : 'hidden'}`;
            adjustButtons.id = `adjust-buttons-${index}`;

            const minusButton = document.createElement('button');
            minusButton.textContent = '-';
            minusButton.addEventListener('click', () => {
                task.time = Math.max(0, task.time - 900); // Subtract 15 minutes
                updateLocalStorage();
                renderTasks();
            });

            const plusButton = document.createElement('button');
            plusButton.textContent = '+';
            plusButton.addEventListener('click', () => {
                task.time += 900; // Add 15 minutes
                updateLocalStorage();
                renderTasks();
            });

            const decimalTime = document.createElement('div');
            decimalTime.className = `decimal-time ${showTotals ? '' : 'hidden'}`;
            decimalTime.id = `decimal-time-${index}`;
            const decimalValue = roundToQuarterHour(task.time / 60);
            decimalTime.textContent = decimalValue.toFixed(2);

            adjustButtons.appendChild(minusButton);
            adjustButtons.appendChild(plusButton);
            taskRow.appendChild(adjustButtons);
            taskRow.appendChild(decimalTime);

            return taskRow;
        }

        function renderTasks() {
            const tasksContainer = document.getElementById('tasks');
            tasksContainer.innerHTML = '';
            tasks.forEach((task, index) => {
                const taskRow = createTaskRow(task, index);

                // Hide start/stop and delete buttons when totals are shown
                const startStopButton = taskRow.querySelector('.StartStop');
                const deleteButton = taskRow.querySelector('.fa-trash-alt').parentElement; // Select the parent button of trash icon
                if (showTotals) {
                    startStopButton.classList.add('hidden');
                    // deleteButton.classList.add('hidden');
                } else {
                    startStopButton.classList.remove('hidden');
                    // deleteButton.classList.remove('hidden');
                }

                tasksContainer.appendChild(taskRow);
            });
            if (showTotals) {
                calculateTotalSum();
            } else {
                document.getElementById('totalsSum').classList.add('hidden');
            }
        }

        function calculateTotalSum() {
            let totalSum = tasks.reduce((sum, task) => sum + roundToQuarterHour(task.time / 60), 0);
            document.getElementById('totalsSum').textContent = `Total: ${totalSum.toFixed(2)} hours`;
            document.getElementById('totalsSum').classList.remove('hidden');
        }

        function updateTimers() {
            tasks.forEach((task, index) => {
                if (task.isRunning) {
                    task.time = Math.floor((Date.now() - task.startTime) / 1000);
                    document.getElementById(`timer-${index}`).textContent = formatTime(task.time);
                }
            });
            updateLocalStorage();
        }

        document.getElementById('addTaskButton').addEventListener('click', () => {
            tasks.push({ name: '', time: 0, isRunning: false, startTime: null });
            updateLocalStorage();
            renderTasks();
        });

        document.getElementById('toggleTotalsButton').addEventListener('click', () => {
            showTotals = !showTotals;

            // Stop any running timers when showing totals
            if (showTotals) {
                tasks.forEach(task => task.isRunning = false);
                updateLocalStorage();
                document.getElementById('toggleTotalsButton').textContent = 'Hide Totals';
            } else {
                document.getElementById('toggleTotalsButton').textContent = 'Show Totals';
                document.getElementById('totalsSum').classList.add('hidden');
            }

            renderTasks();
        });

        renderTasks();
        setInterval(updateTimers, 1000);
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
</body>

</html>