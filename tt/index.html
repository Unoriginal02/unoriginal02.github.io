<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Taskifactorio</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Fonts and CSS -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Nunito:ital,wght@0,200..1000;1,200..1000&display=swap"
        rel="stylesheet">
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

    <style>
        :root {
            --main-color: #eeeeee;
            --main-color-hover: rgba(238, 238, 238, .1);
            --button-active-color: #FC5B5B;
            --button-selection-color: #5f92f0;
            --background-color: #000000;
            --main-color-rgb: 238, 238, 238;
            --main-color-opacity: rgba(var(--main-color-rgb), 0.12);
        }

        body {
            margin: 0;
            background-color: var(--background-color);
            color: var(--main-color);
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
        }

        input::placeholder {
            color: rgba(var(--main-color-rgb), 0.5);
            /* Assuming you have the main color as an RGB value */
        }

        .maxwidth {
            max-width: 960px;
            margin: auto;
            display: flex;
            flex-direction: column;
        }

        .task-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .task-row input[type="text"] {
            flex-grow: 1;
            height: 42px;
            padding: 4px 16px;
            background-color: var(--background-color);
            color: var(--main-color);
            border: 1px solid var(--main-color);
            margin-right: -1px;
        }

        .task-row button {
            height: 42px;
            border: 1px solid var(--main-color);
            background-color: var(--background-color);
            color: var(--main-color);
            padding: 8px 13px;
            border-radius: 0;
            margin-right: -1px;
        }

        .task-row .timer {
            min-width: 80px;
            height: 42px;
            text-align: center;
            margin-right: -1px;
            border: 1px solid var(--main-color);
            padding: 8px 16px;
        }

        .task-row .adjust-buttons {
            display: flex;
            align-items: center;
            margin-right: -1px;
        }

        .task-row .adjust-buttons button {
            margin-right: -1px;
            font-size: 1rem;
        }

        .task-row .decimal-time {
            font-size: 1rem;
            margin-left: 1px;
            width: 82px;
            text-align: left;
            border: 1px solid var(--main-color);
            padding: 8px 16px;
        }

        .hidden {
            display: none !important;
        }

        .button-active {
            background-color: var(--button-active-color) !important;
            border: 2px solid var(--main-color);
            /* outer main color border */
            padding: 6px;
            /* adjust padding to accommodate border size */
            color: var(--main-color) !important;
            box-shadow: inset 0 0 0 2px var(--background-color);
            /* inner black border */
        }

        .StartStop {
            width: 96px;
        }

        .brutalButton {
            border: 1px solid var(--main-color);
            background-color: var(--background-color);
            color: var(--main-color);
            padding: .5rem 0;
            border-radius: 0;
            white-space: nowrap;
            width: 100%;
            min-width: 100px;
        }

        .brutalButton:hover {
            background-color: var(--main-color-hover);
            color: var(--main-color);
        }

        .brutal-list-group {
            flex-grow: 1;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--main-color);
            background-color: var(--background-color);
            color: var(--main-color);
            padding: .5rem .5rem;
            margin-right: -1px;
            border-radius: 0;
            text-align: left;
        }

        .brutalInput {
            flex-grow: 1;
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--main-color);
            background-color: var(--background-color);
            color: var(--main-color);
            padding: .5rem .5rem;
            margin-right: -1px;
            border-radius: 0;
            text-align: left;
        }

        .form-control:focus {
            background-color: rgba(255, 255, 255, .1) !important;
            border-color: var(--main-color);
            outline: 0;
            box-shadow: none;
        }

        input:focus,
        select:focus,
        textarea:focus {
            outline: none;
            /* Disables the default focus outline */
            box-shadow: none;
            /* Removes any default focus shadow (if any) */
        }

        .brutalInput:focus {
            color: var(--main-color);
            outline: none;
        }

        .brutalInput::placeholder {
            color: var(--main-color);
        }

        .mt-neg-1 {
            margin-top: -1px;
        }

        .task-row select {
            height: 42px;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
            width: 10%;
        }

        .buttonGroup {
            display: flex;
            flex-direction: row;
            gap: 16px;
        }

        .project-id-field {
            width: 10%;
        }

        #task-input {
            width: 30%;
        }

        .drag-handle {
            cursor: move;
            height: 42px;
            padding: 4px 10px;
            display: flex;
            margin-right: -1px;
            align-items: center;
            border: 1px solid var(--main-color);
        }

        .drag-handle i {
            color: var(--main-color);
            font-size: 1.2rem;
        }

        .mt-xusta {
            margin-top: 6px;
        }

        .total-sum {
            border: 1px solid var(--main-color);
            padding: 8px;
            border-radius: 0px;
        }

        .copy-effect {
            animation: fillAndFadeInput 0.5s forwards;
        }

        @keyframes fillAndFadeInput {
            0% {
                background: var(--button-selection-color);
                box-shadow: inset 0 0 0 2px var(--background-color);
            }

            10% {
                background: var(--button-selection-color);
                box-shadow: inset 0 0 0 2px var(--background-color);
            }


            100% {
                background: transparent;
                box-shadow: inset 0 0 0 2px var(--background-color);
            }
        }

        .link-button {
            height: 42px;
            border: 1px solid var(--main-color);
            background-color: var(--background-color);
            color: var(--main-color);
            padding: 8px 13px;
            border-radius: 0;
            margin-right: -1px;
        }

        .link-button:hover {
            background-color: var(--main-color-hover);
            color: var(--main-color);
        }

        .link-button i {
            font-size: 1rem;
        }

        .mode-buttons {
            position: fixed;
            font-size: .75rem;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .mode-switcher {
            border: 1px solid var(--main-color);
            background-color: var(--background-color);
            color: var(--main-color);
            padding: 8px 16px;
            font-family: 'JetBrains Mono', monospace;
            cursor: pointer;
        }

        .mode-switcher.active-mode {
            background-color: var(--main-color-opacity);
            border: 1px solid var(--main-color);
            color: var(--main-color);
        }

        .mode-switcher:hover {
            background-color: var(--main-color-hover);
        }

        /* Light Mode */
        .light-mode {
            --main-color: #333333;
            --main-color-hover: rgba(0, 0, 0, 0.02);
            --button-active-color: #FC5B5B;
            --button-selection-color: #5f92f0;
            --background-color: #ffffff;
            --main-color-rgb: 0, 0, 0;
            --main-color-opacity: rgba(var(--main-color-rgb), 0.04);
            color: var(--main-color);
        }

        /* Demure Mode (Pastel Palette) */
        .demure-mode {
            font-family: "Nunito", sans-serif;
            /* --main-color: #f4978e; */
            --main-color: #db7970;
            --main-color-hover: rgba(219, 121, 112, 0.1);
            /* Softer hover effect */
            /* --button-active-color: #d8f0d8; */
            --button-active-color: #c9eed8;
            /* Soft peachy pink */
            --button-selection-color: var(--button-active-color);
            /* Pastel peach */
            --background-color: #fef5f5;

            --main-color-rgb: 219, 121, 112;

            --main-color-opacity: rgba(var(--main-color-rgb), 0.09);
            /* Light pinkish-peach background */
            color: var(--main-color);
        }

        .demure-mode body {
            filter: none;
        }

        .demure-mode input::placeholder {
            color: rgba(var(--main-color-rgb), 0.8);
            /* Assuming you have the main color as an RGB value */
        }

        .demure-mode .brutalButton,
        .demure-mode .StartStop {
            background-color: var(--background-color);
            color: var(--main-color);
            border-color: var(--main-color);
        }

        .demure-mode .brutalButton:hover,
        .demure-mode .StartStop:hover {
            background-color: var(--main-color-hover);
        }

        .demure-mode .mode-switcher {
            border-radius: 60px;
        }


        .demure-mode .brutalButton {
            border-radius: 60px;
        }

        .demure-mode .drag-handle {
            padding-left: 1.1rem;
            border-radius: 20px 0 0 20px;
        }

        .demure-mode .trash-button {
            padding-right: 1.1rem;
            border-radius: 0 20px 20px 0;
        }

        .demure-mode .total-sum {
            border-radius: 60px;
        }

        .demure-mode .decimal-time {
            padding-right: 1.1rem;
            border-radius: 0 20px 20px 0;
        }

        .demure-mode .mode-switcher {
            font-family: "Nunito", sans-serif;
        }

        .mode-buttons {
            display: flex;
            flex-direction: row;
        }

        .show-totals-active #tasks .trash-button {
            border-radius: 0;
        }

        .trash-button:hover {
            background-color: var(--main-color-hover);
            color: var(--main-color);
        }

        .trash-button:hover i {
            color: var(--main-color);
        }

        .adjust-buttons button:hover {
            background-color: var(--main-color-hover);
            color: var(--main-color);
        }

        .adjust-buttons button:hover i {
            color: var(--main-color);
        }

        .drag-handle:hover {
            background-color: var(--main-color-hover);
            color: var(--main-color);
        }

        .drag-handle:hover i {
            color: var(--main-color);
        }

        .pointer-cursor {
            cursor: pointer;
        }

        .copy-button:hover {
            background-color: var(--main-color-hover);
            color: var(--main-color);
        }

        .show-totals-active .project-id-field,
        .show-totals-active .decimal-time {
            cursor: pointer;
        }

        .show-totals-active .project-id-field:hover,
        .show-totals-active .decimal-time:hover {
            background-color: var(--main-color-hover);
        }
    </style>
</head>

<body>
    <div class="maxwidth container text-center my-5">
        <div class="buttonGroup mt-3">
            <button id="addTaskButton" class="brutalButton">Add New Task</button>
            <button id="toggleTotalsButton" class="brutalButton">Show Totals</button>
        </div>
        <div id="tasks" class="mt-3"></div>
        <div id="totalsSum" class="mt-xusta hidden total-sum"></div>
        <!-- Export/Import buttons under total hours -->
        <div id="exportImportContainer" class="buttonGroup mt-3 hidden">
            <button id="exportDataButton" class="brutalButton">Export</button>
            <input type="file" id="importDataInput" class="hidden" accept=".json">
            <button id="importDataButton" class="brutalButton">Import</button>
        </div>
        <div class="buttonGroup mt-3">
            <button id="toggleProjectsButton" class="brutalButton">Projects</button>
            <button id="wipeTimersButton" class="brutalButton">Wipe Timers</button>
            <button id="deleteTasksButton" class="brutalButton">Delete Tasks</button>
        </div>
        <div id="projects" class="mt-3 hidden">
        </div>
    </div>
    <div class="mode-buttons">
        <button id="lightModeButton" class="mode-switcher">
            <i class="bi bi-sun"></i> Light Mode
        </button>
        <button id="darkModeButton" class="mode-switcher">
            <i class="bi bi-moon"></i> Dark Mode
        </button>
        <button id="demureModeButton" class="mode-switcher">
            <i class="bi bi-stars"></i> Demure Mode
        </button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>

    <script>
        (function () {
            'use strict';

            // Function to update the active mode button
            function updateActiveModeButton(activeButtonId) {
                const modeButtons = document.querySelectorAll('.mode-switcher');
                modeButtons.forEach(button => {
                    if (button.id === activeButtonId) {
                        button.classList.add('active-mode');
                    } else {
                        button.classList.remove('active-mode');
                    }
                });
            }

            // Load stored theme mode from localStorage
            const storedThemeMode = localStorage.getItem('themeMode');
            if (storedThemeMode) {
                if (storedThemeMode === 'light-mode') {
                    document.body.classList.add('light-mode');
                    updateActiveModeButton('lightModeButton');
                } else if (storedThemeMode === 'demure-mode') {
                    document.body.classList.add('demure-mode');
                    updateActiveModeButton('demureModeButton');
                } else {
                    // Default to dark mode if 'dark-mode' or unknown value
                    updateActiveModeButton('darkModeButton');
                }
            } else {
                // Default to dark mode
                updateActiveModeButton('darkModeButton');
            }

            // Dark Mode Button
            document.getElementById('darkModeButton').addEventListener('click', () => {
                document.body.classList.remove('light-mode', 'demure-mode');
                localStorage.setItem('themeMode', 'dark-mode');
                updateActiveModeButton('darkModeButton');
            });

            // Light Mode Button
            document.getElementById('lightModeButton').addEventListener('click', () => {
                document.body.classList.remove('demure-mode');
                document.body.classList.add('light-mode');
                localStorage.setItem('themeMode', 'light-mode');
                updateActiveModeButton('lightModeButton');
            });

            // Demure Mode Button
            document.getElementById('demureModeButton').addEventListener('click', () => {
                document.body.classList.remove('light-mode');
                document.body.classList.add('demure-mode');
                localStorage.setItem('themeMode', 'demure-mode');
                updateActiveModeButton('demureModeButton');
            });

            (function () {
                const HEARTBEAT_KEY = 'app_heartbeat';
                const HEARTBEAT_INTERVAL = 1000; // 1 second
                const HEARTBEAT_EXPIRATION = 5000; // 5 seconds

                const instanceId = Date.now() + '_' + Math.random();

                function sendHeartbeat() {
                    const heartbeat = {
                        id: instanceId,
                        timestamp: Date.now()
                    };
                    localStorage.setItem(HEARTBEAT_KEY, JSON.stringify(heartbeat));
                }

                function getHeartbeat() {
                    const heartbeatData = localStorage.getItem(HEARTBEAT_KEY);
                    return heartbeatData ? JSON.parse(heartbeatData) : null;
                }

                function isHeartbeatValid(heartbeat) {
                    return (Date.now() - heartbeat.timestamp) < HEARTBEAT_EXPIRATION;
                }

                // On page load
                const existingHeartbeat = getHeartbeat();
                if (existingHeartbeat && isHeartbeatValid(existingHeartbeat) && existingHeartbeat.id !== instanceId) {
                    // Another instance is running
                    document.head.innerHTML = ''; // Clear any existing head content
                    document.body.innerHTML = '<h3 id="block-message">There is another instance of this app open.</h3>';

                    // Add CSS styles to center the message
                    const style = document.createElement('style');
                    style.innerHTML = `
                    body {
                        display: flex;
                        justify-content: center;
                        align-items: center;
                        min-height: 100vh;
                        margin: 0;
                        background-color: #000000;
                        color: #eeeeee;
                    }

                    #block-message {
                        text-align: center;
                        font-family: 'JetBrains Mono', monospace;
                    }
                    `;
                    document.head.appendChild(style);
                    return; // Stop execution
                } else {
                    // No valid heartbeat, proceed to run
                    sendHeartbeat();

                    // Update the heartbeat periodically
                    const heartbeatInterval = setInterval(sendHeartbeat, HEARTBEAT_INTERVAL);

                    // Clean up on unload
                    window.addEventListener('beforeunload', () => {
                        localStorage.removeItem(HEARTBEAT_KEY);
                        clearInterval(heartbeatInterval);
                    });
                }

                let sortableInstance;
                let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
                let projects = JSON.parse(localStorage.getItem('projects')) || [];
                let showTotals = false;

                function copyTextToClipboard(element) {
                    return navigator.clipboard.writeText(element.value || element.textContent);
                }

                function copyTextToClipboardEffect(element) {
                    element.classList.add('copy-effect');
                    setTimeout(() => {
                        element.classList.remove('copy-effect');
                    }, 500); // Match this duration to the CSS animation duration
                }

                function updateLocalStorage() {
                    localStorage.setItem('tasks', JSON.stringify(tasks));
                }

                function updateProjectsLocalStorage() {
                    localStorage.setItem('projects', JSON.stringify(projects));
                }

                function formatTime(seconds) {
                    const hrs = String(Math.floor(seconds / 3600)).padStart(2, '0');
                    const mins = String(Math.floor((seconds % 3600) / 60)).padStart(2, '0');
                    const secs = String(seconds % 60).padStart(2, '0');
                    return `${hrs}:${mins}:${secs}`;
                }

                function roundToQuarterHour(minutes) {
                    return Math.round(minutes / 15) * 0.25;
                }

                function roundUpToNearest15Minutes(seconds) {
                    const minutes = Math.ceil(seconds / 60);
                    const remainder = minutes % 15;
                    if (remainder === 0) {
                        return seconds;
                    } else {
                        return (minutes + (15 - remainder)) * 60;
                    }
                }

                function roundDownToNearest15Minutes(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    const remainder = minutes % 15;
                    if (remainder === 0) {
                        return seconds;
                    } else {
                        return (minutes - remainder) * 60;
                    }
                }

                function createTaskRow(task, index, totalTaskTime) {
                    const taskRow = document.createElement('div');
                    taskRow.className = 'task-row';

                    // Drag Handle
                    const dragHandle = document.createElement('div');
                    dragHandle.className = 'drag-handle';
                    dragHandle.innerHTML = '<i class="bi bi-grip-vertical"></i>';
                    taskRow.appendChild(dragHandle);

                    // Project dropdown
                    const projectDropdown = document.createElement('select');
                    projectDropdown.className = 'brutal-list-group';

                    const defaultOption = document.createElement('option');
                    defaultOption.text = 'Select';
                    defaultOption.value = '';
                    projectDropdown.classList.add('pointer-cursor');
                    projectDropdown.appendChild(defaultOption);

                    projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.text = project.name;
                        if (task.projectId === project.id) {
                            option.selected = true;
                        }
                        projectDropdown.appendChild(option);
                    });

                    projectDropdown.addEventListener('change', () => {
                        const selectedProject = projects.find(project => project.id === projectDropdown.value);
                        if (selectedProject) {
                            task.projectId = selectedProject.id;
                            task.projectName = selectedProject.name;
                        } else {
                            task.projectId = '';
                            task.projectName = '';
                        }
                        projectIdField.value = task.projectId;
                        updateLocalStorage();
                    });

                    const projectIdField = document.createElement('input');
                    projectIdField.type = 'text';
                    // projectIdField.id = 'project-id-field';
                    projectIdField.value = task.projectId || '';
                    projectIdField.className = 'brutalInput project-id-field';
                    projectIdField.readOnly = true;
                    projectIdField.addEventListener('click', () => {
                        if (showTotals) {
                            copyTextToClipboard(projectIdField, task.projectId).then(() => copyTextToClipboardEffect(projectIdField));
                        }
                    });

                    // Create the link button
                    const linkButton = document.createElement('button');
                    linkButton.className = 'link-button';
                    linkButton.innerHTML = '<i class="bi bi-box-arrow-up-right"></i>';
                    linkButton.addEventListener('click', () => {
                        const projectId = projectIdField.value.trim();
                        if (projectId) {
                            const url = `http://jirafa.tlgcommerce.com:8080/browse/${encodeURIComponent(projectId)}`;
                            window.open(url, '_blank');
                        } else {
                            alert('Project ID is empty.');
                        }
                    });

                    // Task input field
                    const taskInput = document.createElement('input');
                    taskInput.type = 'text';
                    taskInput.id = 'task-input';
                    taskInput.value = task.name;
                    taskInput.placeholder = 'Enter task name';
                    // taskInput.readOnly = showTotals;
                    taskInput.addEventListener('input', () => {
                        task.name = taskInput.value;
                        updateLocalStorage();
                    });
                    // taskInput.addEventListener('click', () => {
                    //     if (showTotals) {
                    //         copyTextToClipboard(taskInput, task.name);
                    //     }
                    // });


                    // Copy button
                    const copyButton = document.createElement('button');
                    copyButton.className = 'copy-button ' + (showTotals ? '' : 'hidden'); // Make it hidden unless showTotals is active
                    copyButton.innerHTML = '<i class="bi bi-clipboard"></i>';
                    copyButton.addEventListener('click', () => {
                        const row = copyButton.closest('.task-row');
                        copyTextToClipboard(row.querySelector('.decimal-time'))
                            .then(() => {
                                // console.log('copi 1');

                                // Pass copyButton to apply flashing effect
                                setTimeout(() => {
                                    copyTextToClipboard(taskInput, copyButton).then(() => {
                                        // console.log('copi 2');
                                        setTimeout(() => {
                                            copyTextToClipboard(row.querySelector('.project-id-field'))
                                                .then(() => {
                                                    // console.log('copi 3');
                                                    copyTextToClipboardEffect(copyButton)
                                                });
                                        }, 250)
                                    })
                                }, 250)
                            });
                    });

                    const percentageOfTotal = totalTaskTime > 0 ? (task.time / totalTaskTime) * 150 : 0;
                    taskInput.style.background = `linear-gradient(to right, var(--main-color-opacity) ${percentageOfTotal}%, var(--background-color) ${percentageOfTotal}%)`;

                    // Timer display
                    const timerDisplay = document.createElement('div');
                    timerDisplay.className = 'timer';
                    timerDisplay.textContent = formatTime(task.time);
                    timerDisplay.id = `timer-${index}`;

                    // Start/Stop button
                    const startStopButton = document.createElement('button');
                    startStopButton.textContent = task.isRunning ? 'Stop' : 'Start';
                    startStopButton.classList.add('StartStop');
                    if (task.isRunning) {
                        startStopButton.classList.add('button-active');
                    } else {
                        startStopButton.classList.remove('button-active');
                    }
                    startStopButton.addEventListener('click', () => {
                        tasks.forEach((t, i) => {
                            if (i !== index) {
                                t.isRunning = false;
                            }
                        });
                        task.isRunning = !task.isRunning;
                        if (task.isRunning) {
                            task.startTime = Date.now() - task.time * 1000;
                        }
                        updateLocalStorage();
                        renderTasks();
                    });

                    // Delete button
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'trash-button';
                    deleteButton.innerHTML = '<i class="bi bi-trash3"></i>';
                    deleteButton.addEventListener('click', () => {
                        if (confirm('Are you sure you want to delete this task?')) {
                            tasks.splice(index, 1);
                            updateLocalStorage();
                            renderTasks();
                        }
                    });

                    // Adjust buttons
                    const adjustButtons = document.createElement('div');
                    adjustButtons.className = `adjust-buttons ${showTotals ? '' : 'hidden'}`;
                    adjustButtons.id = `adjust-buttons-${index}`;

                    const minusButton = document.createElement('button');
                    minusButton.className = 'bi bi-dash-lg';
                    minusButton.addEventListener('click', () => {
                        if (task.time % 900 !== 0) {
                            task.time = roundDownToNearest15Minutes(task.time);
                        } else {
                            task.time = Math.max(0, task.time - 900);
                        }
                        updateLocalStorage();
                        renderTasks();
                    });

                    const plusButton = document.createElement('button');
                    plusButton.className = 'bi bi-plus-lg';
                    plusButton.addEventListener('click', () => {
                        if (task.time % 900 !== 0) {
                            task.time = roundUpToNearest15Minutes(task.time);
                        } else {
                            task.time += 900;
                        }
                        updateLocalStorage();
                        renderTasks();
                    });

                    adjustButtons.appendChild(minusButton);
                    adjustButtons.appendChild(plusButton);

                    // Decimal time display
                    const decimalTime = document.createElement('div');
                    decimalTime.className = `decimal-time ${showTotals ? '' : 'hidden'}`;
                    decimalTime.id = `decimal-time-${index}`;
                    const decimalValue = roundToQuarterHour(task.time / 60);
                    decimalTime.textContent = parseFloat(decimalValue.toFixed(2));
                    decimalTime.addEventListener('click', () => {
                        copyTextToClipboard(decimalTime, decimalTime.textContent).then(() => copyTextToClipboardEffect(decimalTime));
                    });

                    // Append elements to taskRow
                    taskRow.appendChild(projectDropdown);
                    taskRow.appendChild(projectIdField);
                    taskRow.appendChild(linkButton); // Add this line
                    taskRow.appendChild(taskInput);
                    taskRow.appendChild(timerDisplay);
                    taskRow.appendChild(startStopButton);
                    taskRow.appendChild(deleteButton);
                    taskRow.appendChild(adjustButtons);
                    taskRow.appendChild(decimalTime);
                    taskRow.appendChild(copyButton); // Add this line

                    return taskRow;
                }

                function renderTasks() {
                    const tasksContainer = document.getElementById('tasks');
                    tasksContainer.innerHTML = '';
                    const totalTaskTime = tasks.reduce((sum, task) => sum + task.time, 0);

                    tasks.forEach((task, index) => {
                        const taskRow = createTaskRow(task, index, totalTaskTime);
                        const taskInput = taskRow.querySelector('input[type="text"]');
                        const startStopButton = taskRow.querySelector('.StartStop');

                        if (showTotals) {
                            startStopButton.classList.add('hidden');
                        } else {
                            startStopButton.classList.remove('hidden');
                        }

                        tasksContainer.appendChild(taskRow);
                    });

                    // Re-initialize SortableJS
                    sortableInstance = Sortable.create(tasksContainer, {
                        animation: 150,
                        handle: '.drag-handle',
                        onEnd: function (evt) {
                            const movedItem = tasks.splice(evt.oldIndex, 1)[0];
                            tasks.splice(evt.newIndex, 0, movedItem);
                            updateProjectsLocalStorage();
                            renderTasks();
                        },
                    });

                    if (showTotals) {
                        calculateTotalSum();
                    } else {
                        document.getElementById('totalsSum').classList.add('hidden');
                        hideExportImportButtons();
                    }
                }

                function createProjectRow(project, index) {
                    const projectRow = document.createElement('div');
                    projectRow.className = 'task-row';

                    // Drag Handle
                    const dragHandle = document.createElement('div');
                    dragHandle.className = 'drag-handle';
                    dragHandle.innerHTML = '<i class="bi bi-grip-vertical"></i>';
                    projectRow.appendChild(dragHandle);

                    const projectNameInput = document.createElement('input');
                    projectNameInput.type = 'text';
                    projectNameInput.value = project.name;
                    projectNameInput.placeholder = 'Enter project name';
                    projectNameInput.addEventListener('input', () => {
                        project.name = projectNameInput.value;
                        updateProjectsLocalStorage();
                    });

                    const projectIdInput = document.createElement('input');
                    projectIdInput.type = 'text';
                    projectIdInput.value = project.id;
                    projectIdInput.placeholder = 'Enter project ID';
                    projectIdInput.addEventListener('input', () => {
                        project.id = projectIdInput.value;
                        updateProjectsLocalStorage();
                    });

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'trash-button';
                    deleteButton.innerHTML = '<i class="bi bi-trash3"></i>';
                    deleteButton.addEventListener('click', () => {
                        if (confirm('Are you sure you want to delete this project?')) {
                            projects.splice(index, 1);
                            updateProjectsLocalStorage();
                            renderProjects();
                        }
                    });

                    projectRow.appendChild(projectNameInput);
                    projectRow.appendChild(projectIdInput);
                    projectRow.appendChild(deleteButton);

                    return projectRow;
                }

                function renderProjects() {
                    const projectsContainer = document.getElementById('projects');
                    projectsContainer.innerHTML = '';

                    // Render existing projects
                    projects.forEach((project, index) => {
                        const projectRow = createProjectRow(project, index);
                        projectsContainer.appendChild(projectRow);
                    });

                    // Create a buttons container
                    const buttonsContainer = document.createElement('div');
                    buttonsContainer.className = 'buttonGroup mt-3';

                    // Create the "Add New Project" button
                    const addProjectButton = document.createElement('button');
                    addProjectButton.className = 'brutalButton add-project-button';
                    addProjectButton.textContent = 'Add New Project';
                    addProjectButton.addEventListener('click', () => {
                        projects.push({ name: '', id: 'PRJ-' });
                        updateProjectsLocalStorage();
                        renderProjects();
                    });

                    // Append buttons to buttonsContainer
                    buttonsContainer.appendChild(addProjectButton);

                    // Append buttonsContainer to projectsContainer
                    projectsContainer.appendChild(buttonsContainer);

                    // Re-initialize SortableJS
                    sortableInstance = Sortable.create(projectsContainer, {
                        animation: 150,
                        handle: '.drag-handle',
                        onEnd: function (evt) {
                            const movedItem = projects.splice(evt.oldIndex, 1)[0];
                            projects.splice(evt.newIndex, 0, movedItem);
                            updateProjectsLocalStorage(); // Correct function to update projects in local storage
                            renderProjects();
                        },
                    });
                }

                document.getElementById('toggleProjectsButton').addEventListener('click', () => {
                    const projectsContainer = document.getElementById('projects');
                    const toggleProjectsButton = document.getElementById('toggleProjectsButton'); // get the button element
                    if (projectsContainer.classList.contains('hidden')) {
                        projectsContainer.classList.remove('hidden');
                        toggleProjectsButton.textContent = 'Save'; // change to "Save"
                        renderProjects();
                    } else {
                        projectsContainer.classList.add('hidden');
                        toggleProjectsButton.textContent = 'Projects'; // change back to "Projects"
                        updateProjectsLocalStorage();
                        renderTasks();
                    }
                });

                function calculateTotalSum() {
                    const totalSum = tasks.reduce((sum, task) => sum + roundToQuarterHour(task.time / 60), 0);
                    document.getElementById('totalsSum').textContent = `Total: ${parseFloat(totalSum.toFixed(2))} hours`;
                    document.getElementById('totalsSum').classList.remove('hidden');

                    // Show the export/import buttons when showing totals
                    document.getElementById('exportImportContainer').classList.remove('hidden');
                }

                function hideExportImportButtons() {
                    document.getElementById('exportImportContainer').classList.add('hidden');
                }

                // Add event listeners for the export/import buttons
                document.getElementById('exportDataButton').addEventListener('click', () => {
                    const data = {
                        tasks: tasks,
                        projects: projects
                    };
                    const dataStr = JSON.stringify(data, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);

                    const a = document.createElement('a');
                    a.href = url;

                    // Generate the date string in DD-MM-YYYY format with leading zeros
                    const today = new Date();
                    const day = String(today.getDate()).padStart(2, '0');
                    const month = String(today.getMonth() + 1).padStart(2, '0'); // Months are zero-based
                    const year = today.getFullYear();
                    const filename = `Taskifactorio Data ${day}-${month}-${year}.json`;

                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                });

                document.getElementById('importDataButton').addEventListener('click', () => {
                    document.getElementById('importDataInput').click();
                });

                document.getElementById('importDataInput').addEventListener('change', (event) => {
                    const file = event.target.files[0];
                    if (file && file.type === 'application/json') {
                        const reader = new FileReader();
                        reader.onload = function (e) {
                            try {
                                const importedData = JSON.parse(e.target.result);
                                if (importedData.tasks && importedData.projects) {
                                    tasks = importedData.tasks;
                                    projects = importedData.projects;
                                    updateLocalStorage();
                                    updateProjectsLocalStorage();
                                    renderTasks();
                                    alert('Data imported successfully.');
                                } else {
                                    alert('Invalid data format.');
                                }
                            } catch (error) {
                                alert('Error parsing JSON file.');
                            }
                        };
                        reader.readAsText(file);
                    } else {
                        alert('Please select a valid JSON file.');
                    }
                });

                function updateTimers() {
                    tasks.forEach((task, index) => {
                        if (task.isRunning) {
                            task.time = Math.floor((Date.now() - task.startTime) / 1000);
                            const timerDisplay = document.getElementById(`timer-${index}`);
                            if (timerDisplay) {
                                timerDisplay.textContent = formatTime(task.time);
                            }
                        }
                    });
                    updateLocalStorage();
                }

                document.getElementById('addTaskButton').addEventListener('click', () => {
                    tasks.push({ name: '', time: 0, isRunning: false, startTime: null });
                    updateLocalStorage();
                    renderTasks();
                    const taskInputs = document.querySelectorAll('.task-row input[type="text"]');
                    const lastTaskInput = taskInputs[taskInputs.length - 1];
                    if (lastTaskInput) {
                        lastTaskInput.focus();
                    }
                });

                // Modify your toggleTotalsButton event listener to hide the export/import buttons when totals are hidden
                document.getElementById('toggleTotalsButton').addEventListener('click', () => {
                    showTotals = !showTotals;

                    if (showTotals) {
                        tasks.forEach(task => task.isRunning = false);
                        updateLocalStorage();
                        document.getElementById('toggleTotalsButton').textContent = 'Hide Totals';
                        document.body.classList.add('show-totals-active');
                        renderTasks();
                    } else {
                        document.getElementById('toggleTotalsButton').textContent = 'Show Totals';
                        document.getElementById('totalsSum').classList.add('hidden');
                        hideExportImportButtons(); // Hide the export/import buttons when totals are hidden
                        document.body.classList.remove('show-totals-active');
                        renderTasks();
                    }
                });

                document.getElementById('wipeTimersButton').addEventListener('click', () => {
                    if (confirm('Are you sure you want to reset all timers to 0?')) {
                        tasks.forEach(task => task.time = 0);
                        updateLocalStorage();
                        renderTasks();
                    }
                });

                document.getElementById('deleteTasksButton').addEventListener('click', () => {
                    if (confirm('Are you sure you want to delete all tasks?')) {
                        tasks = [];
                        updateLocalStorage();
                        renderTasks();
                    }
                });

                renderTasks();
                setInterval(updateTimers, 1000);

            })();
        })();
    </script>

</body>

</html>