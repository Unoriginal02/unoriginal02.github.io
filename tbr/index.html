<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Task Battle</title>

    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono&display=swap" rel="stylesheet">


    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">

    <style>
        :root {
            --main-color: #eeeeee;
            --main-color-hover: rgba(238, 238, 238, .1);
            /* Define the main color variable */
        }

        html,
        body {
            height: 100%;
            margin: 0;
            /* Remove default margin */
        }

        body {
            background-color: #000000;
            /* Dark background */
            color: var(--main-color);
            /* Light text color */
            font-family: 'JetBrains Mono', monospace;
            display: flex;
            justify-content: center;
            /* Horizontally center the content */
            align-items: center;
            /* Vertically center the content */
            flex-direction: column;
            /* Stack flex items vertically */
            min-height: 100vh;
            /* Minimum height of 100% of the viewport height */
        }

        /* hide the default radio buttons */
        input[type="checkbox"] {
            display: none;
        }

        h2 {
            text-align: center;
        }

        h3 {
            text-align: center;
        }

        #taskInputSection {
            display: flex;
            justify-content: center;
            width: 100%;
            /* Ensure the container takes full width */
        }

        .maxwidth {
            max-width: 800px;
            margin: auto;
            /* Ensures the content remains centered horizontally */
            display: flex;
            flex-direction: column;
        }

        .comparisonSection {
            display: flex;
            flex-direction: column;
        }

        .brutalButton {
            border: 1px solid var(--main-color);
            background-color: #000000;
            color: var(--main-color);
            padding: .5rem 0;
            border-radius: 0;
            white-space: nowrap;
            /* Prevent text wrapping */
            min-width: 100px;
            /* Adjust based on your needs */
        }

        .brutalButton:hover {
            background-color: var(--main-color-hover);
            color: var(--main-color);
        }

        .brutalButton:last-child {
            margin-right: 0;
        }

        .brutal-list-group {
            flex-grow: 1;
            /* Make input take up available space */
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--main-color);
            background-color: #000000;
            color: var(--main-color);
            padding: .5rem .5rem;
            margin-right: -1px;
            /* Overlap borders */
            border-radius: 0;
            text-align: center;
        }

        .brutalInput {
            flex-grow: 1;
            /* Make input take up available space */
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid var(--main-color);
            background-color: #000000;
            color: var(--main-color);
            padding: .5rem .5rem;
            margin-right: -1px;
            /* Overlap borders */
            border-radius: 0;
            text-align: center;
        }

        button:focus {
            /* outline: 1px dotted; */
            outline: 0px auto -webkit-focus-ring-color;
            background-color: rgba(255, 255, 255, .1);
        }

        .form-control:focus {
            background-color: rgba(255, 255, 255, .1) !important;
            border-color: var(--main-color);
            outline: 0;
            box-shadow: none;
        }

        .brutalInput:focus {
            background-color: #333333;
            color: var(--main-color);
            /* Change text color to light gray when focused */
            outline: none;
            /* Remove the default focus outline */
        }

        .brutalInput::placeholder {
            /* Change the color of placeholders */
            color: var(--main-color);
        }

        .marginAdjust {
            margin-top: -1px;
        }

        .marginAdjust-right {
            margin-right: -1px;
        }

        .brutal-list-group-item {
            position: relative;
            display: block;
            padding: 0.5rem 1rem;
            color: var(--main-color);
            text-decoration: none;
            text-align: left;
            gap: 1rem;
        }

        .brutal-card {
            position: relative;
            display: flex;
            flex-direction: column;
            min-width: 0;
            width: 100%;
            word-wrap: break-word;
            background-clip: border-box;
            border: 1px solid var(--main-color);
            margin-top: -1px;
        }

        .brutal-card:hover {
            background-color: var(--main-color-hover);
        }

        .leaderboard {
            background-color: #000000;
            color: var(--main-color);
            text-align: left;
            font-family: 'JetBrains Mono', monospace;
            margin: 0 auto;
        }

        .leaderboard-row {
            display: flex;
            justify-content: start;
            padding: 10px;
        }

        .leaderboard-row:nth-child(odd) {
            background-color: #111111;
        }

        .leaderboard-top {
            color: #AAF05F;
            font-size: 1.25rem;
        }

        .leaderboard-rank {
            width: 50px;
        }

        .leaderboard-name {
            flex: 1;
        }

        .leaderboard-score {
            text-align: right;
        }

        .card-title {
            margin-bottom: 0rem;
        }

        .comparisonBlock {
            flex-direction: row;
            gap: 1rem;
            align-items: center;
        }

        @media (max-width: 768px) {
            .comparisonBlock {
                flex-direction: column;
                gap: 1rem;
            }

            .cardbody {
                margin-top: -1px;
            }
        }

        .or {
            white-space: nowrap;
        }

        @keyframes push {
            0% {
                transform: scale(1);
                /* Original size */
            }

            20% {
                transform: scale(0.8);
                /* Shrink */
            }

            70% {
                transform: scale(1.2);
                /* Slightly larger */
            }

            100% {
                transform: scale(1);
                /* Return to original size */
            }
        }

        /* style the custom radio buttons */
        .custom-radio {
            display: flex;
            align-items: center;
            width: 48px;
            height: 48px;

            background-image: url('./img/heart-empty.png');
            background-repeat: no-repeat;
            background-size: contain;
            cursor: pointer;
            opacity: 0.4;
            transition: opacity 0.25s ease-out;
            /* Smooth transition for opacity change */
        }

        .custom-radio:hover {
            opacity: 0.6;
        }

        input[type="checkbox"]:checked+.custom-radio {
            background-image: url('./img/heart-fill.png');
            opacity: 1;
            animation: push 0.25s ease-out;
        }

        .leaderboard-hearts {
            display: flex;
            margin-right: 1rem;
            gap: .5rem;
            align-items: center;
        }
    </style>

</head>

<body>

    <div class="maxwidth container text-center my-5">
        <h2>Task Battle Royale</h2>

        <div id="taskInputSection" class="justify-content-center mt-3">
            <input type="text" id="taskInput" class="form-control brutalInput" placeholder="Enter a task">
            <button class="btn brutalButton" onclick="addTask()">Add Task</button>
        </div>
        <div id="taskListSection" class="my-3"></div>
        <button id="compareButton" class="btn brutalButton" onclick="startComparison()">Compare</button>
        <div id="comparisonSection" class="comparisonSection justify-content-center"></div>
        <div id="resultsSection" class="my-3"></div>
        <div id="welcome">
            <p>Welcome to Task Battle Royale.</p>
            <p>This app will allow you to sort your daily tasks by importance</p>
        </div>
        <!-- <div id="scoresSection" class="my-3"></div> -->
    </div>



    <script>
        let heartedTaskIndex = null;
        let heartCounts = {};
        let isInTiebreakerPhase = false;

        function enterTiePhase() {
            document.documentElement.style.setProperty('--main-color', '#FC6B5B');
            document.documentElement.style.setProperty('--main-color-hover', 'rgba(252,107,91,.1)');
            isInTiebreakerPhase = true;
        }

        function exitTiePhase() {
            document.documentElement.style.setProperty('--main-color', '#eeeeee');
            document.documentElement.style.setProperty('--main-color-hover', 'rgba(238,238,238,.1)');
            isInTiebreakerPhase = false;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const taskInput = document.getElementById('taskInput');

            // Event listener for the Enter key on the task input
            taskInput.addEventListener('keydown', function (event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent the default action to avoid form submission if applicable
                    addTask();
                    taskInput.focus(); // Refocus on the input for new task entry
                }
            });

            document.addEventListener('keydown', function (event) {

                if (isInTiebreakerPhase) {
                    // Ensure we are referencing the current tasks being compared correctly
                    let currentComparisons = document.querySelectorAll('.comparisonBlock .card-title');
                    if (currentComparisons.length === 2) {
                        let chosenTask = currentComparisons[event.key === 'ArrowLeft' ? 0 : 1].textContent;
                        chooseTiebreaker(chosenTask);
                    }
                } else {
                    // Check if the comparison section is currently active/displayed
                    if (document.getElementById('comparisonSection').innerHTML !== '') {
                        switch (event.key) {
                            case 'ArrowLeft':
                                // Simulate choosing the first option
                                if (comparisonIndex < comparisons.length) choose(comparisonIndex, 0);
                                break;
                            case 'ArrowRight':
                                // Simulate choosing the second option
                                if (comparisonIndex < comparisons.length) choose(comparisonIndex, 1);
                                break;
                            case 'ArrowUp':
                                // Reset the comparison process
                                resetComparisons();
                                break;
                        }
                    }
                }

            });
            updateCompareButtonVisibility();

            const cardBodies = document.querySelectorAll('.card-body');

            cardBodies.forEach(cardBody => {
                cardBody.addEventListener('click', function () {
                    // Apply the push-animation class
                    this.classList.add('push-animation');

                    // Listen for the end of the animation and then remove the class
                    this.addEventListener('animationend', () => {
                        this.classList.remove('push-animation');
                    }, { once: true }); // The { once: true } option auto-removes the event listener after it fires
                });
            });
        });


        function resetComparisons() {
            comparisonIndex = 0;
            comparisons = [];
            results = {};
            // No need to repopulate tasks from the DOM here, just reset the state
            document.getElementById('comparisonSection').innerHTML = ''; // Clear current comparison
            document.getElementById('resultsSection').innerHTML = ''; // Clear results section
            document.getElementById('taskInputSection').style.display = 'flex'; // Show task input section
            document.getElementById('taskListSection').style.display = 'block'; // Show task list
            document.getElementById('compareButton').style.display = 'block'; // Show compare button
            document.getElementById('welcome').style.display = 'block';
            updateTaskListSection(); // Ensure the task list UI is correctly updated
            heartCounts = {};
            isInTiebreakerPhase = false;
        }

        let tasks = [];
        let comparisons = [];
        let comparisonIndex = 0;
        let results = {};

        function addTask() {
            const taskInput = document.getElementById('taskInput');
            const task = taskInput.value.trim();
            if (task) {
                tasks.push(task);
                taskInput.value = ''; // Clear input field
                updateTaskListSection();
                updateCompareButtonVisibility();
            }
        }


        function updateTaskListSection() {
            const taskListSection = document.getElementById('taskListSection');
            taskListSection.innerHTML = '<ul class="list-group brutal-list-group">' +
                tasks.map((task, index) =>
                    `<li class="brutal-list-group-item d-flex justify-content-between align-items-center">
                ${task} 
                <button class="btn brutalButton btn-sm" onclick="deleteTask(${index})">Delete</button>
            </li>`
                ).join('') +
                '</ul>';
            document.getElementById('welcome').style.display = 'none';
        }


        function deleteTask(index) {
            tasks.splice(index, 1); // Remove the task from the array correctly
            updateTaskListSection(); // Update the task list UI to reflect changes
            updateCompareButtonVisibility();
        }

        function prepareComparisons() {
            comparisons = [];
            for (let i = 0; i < tasks.length; i++) {
                for (let j = i + 1; j < tasks.length; j++) {
                    comparisons.push([tasks[i], tasks[j]]);
                }
            }
            shuffleComparisons(comparisons);
        }

        function shuffleComparisons(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
        }

        function startComparison() {
            document.getElementById('taskInputSection').style.display = 'none';
            document.getElementById('taskListSection').style.display = 'none';
            document.getElementById('compareButton').style.display = 'none';
            document.getElementById('comparisonSection').style.display = 'flex';
            prepareComparisons();
            comparisonIndex = 0;
            if (comparisons.length > 0) {
                showNextComparison();
            } else {
                alert("Please add at least two tasks for comparison.");
                resetComparisons();
            }
        }

        function showNextComparison() {
            if (comparisonIndex < comparisons.length) {
                const comparison = comparisons[comparisonIndex];
                console.log(comparison);
                const comparisonSection = document.getElementById('comparisonSection');
                comparisonSection.innerHTML = `
                <p>Choose the task you consider more important, or chronologically logic.</p>
                <div class="comparisonBlock d-flex justify-content-around my-3">
                    <label>
                        <input type="checkbox" name="preference" id="prefLeft" class="preference-checkbox"/>
                        <span class="custom-radio">
                        </span>
                    </label>
                    <div class="brutal-card marginAdjust-right" style="cursor: pointer;" onclick="choose(${comparisonIndex}, 0)">
                        <div class="card-body">
                            <h5 class="card-title">${comparison[0]}</h5>
                        </div>
                    </div>
                    <div class="or text-center my-auto">- Or -</div>
                    <div class="brutal-card" style="cursor: pointer;" onclick="choose(${comparisonIndex}, 1)">
                        <div class="card-body">
                            <h5 class="card-title">${comparison[1]}</h5>
                        </div>
                    </div>
                    <label>
                        <input type="checkbox" name="preference" id="prefRight" class="preference-checkbox"/>
                        <span class="custom-radio">
                        </span>
                    </label>
                </div>
                <p>Give a like to any task you'd enjoy, but select the one that's most important. Be honest.</p>
            `;
            } else {
                displayResults();
            }
        }

        function choose(index, choice) {
            const chosenTask = comparisons[index][choice];
            // Check if the hearted task should receive extra points
            if (heartedTaskIndex !== null) {
                const heartedTask = comparisons[index][heartedTaskIndex];
                results[heartedTask] = results[heartedTask] ? results[heartedTask] + 0.25 : 0.25;
            }
            results[chosenTask] = results[chosenTask] ? results[chosenTask] + 1 : 1; // Add 1 point to chosen task
            comparisonIndex++;
            heartedTaskIndex = null; // Reset hearted task index
            showNextComparison();
            // updateScoresDisplay();
        }

        function displayResults() {
            document.getElementById('comparisonSection').style.display = 'none'; // Hide comparison section after completion
            const resultsSection = document.getElementById('resultsSection');
            // Ensure all tasks are in the results, even if they have 0 points
            tasks.forEach(task => {
                if (results[task] === undefined) {
                    results[task] = 0;
                }
            });
            let sortedTasks = Object.entries(results).sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0])); // Sort primarily by score, then alphabetically

            // The rest of the displayResults function remains unchanged
            let tiesExist = checkForTies(sortedTasks);
            if (tiesExist) {
                performTiebreakers(); // Handle tiebreakers.
            } else {
                finalizeResultsDisplay(sortedTasks); // Directly display results if no ties
            }
        }

        function checkForTies(sortedTasks) {
            let lastScore = null;
            for (let i = 0; i < sortedTasks.length; i++) {
                if (sortedTasks[i][1] === lastScore) return true;
                lastScore = sortedTasks[i][1];
            }
            return false;
        }

        function performTiebreakers() {

            enterTiePhase();
            // Filter tasks for tiebreaker comparisons
            let tiebreakerTasks = [];
            for (let score in results) {
                if (results.hasOwnProperty(score)) {
                    tiebreakerTasks.push([score, results[score]]);
                }
            }
            // Prepare comparisons for tiebreakerTasks
            comparisons = tiebreakerTasks.map(task => task[0]);
            comparisonIndex = 0;
            startTiebreakerComparison();
        }

        function startTiebreakerComparison() {
            if (comparisons.length > 1) { // Ensure there are at least two tasks to compare
                let tasksForTiebreaker = comparisons.splice(0, 2); // Take first two tasks for comparison
                showTiebreakerComparison(tasksForTiebreaker);
            } else {
                let sortedTasks = Object.entries(results).sort((a, b) => b[1] - a[1]);
                finalizeResultsDisplay(sortedTasks);
            }
            // comparisons = tasks;
        }

        function showTiebreakerComparison(tasks) {
            const comparisonSection = document.getElementById('comparisonSection');
            console.log(tasks);
            comparisonSection.style.display = 'flex';
            comparisonSection.innerHTML = `
            <div class="comparisonBlock d-flex justify-content-around my-3">
                <!-- <input type="radio" name="preference" id="prefLeft" class="preference-radio"/> -->
                <div class="brutal-card marginAdjust-right" style="cursor: pointer;" onclick="chooseTiebreaker('${tasks[0]}')">
                    <div class="card-body">
                        <h5 class="card-title">${tasks[0]}</h5>
                    </div>
                </div>
                <div class="or text-center my-auto">- Or -</div>
                <div class="brutal-card" style="cursor: pointer;" onclick="chooseTiebreaker('${tasks[1]}')">
                    <div class="card-body">
                        <h5 class="card-title">${tasks[1]}</h5>
                    </div>
                </div>
                <!-- <input type="radio" name="preference" id="prefRight" class="preference-radio"/> -->
            </div>
        `;
        }

        function chooseTiebreaker(chosenTask) {
            // Removed reliance on the 'index' variable, which was not defined in this context
            console.log('heartedTaskIndex', heartedTaskIndex);
            // If there was a hearted task, adjust its score
            console.log('choosenTask', chosenTask)

            if (heartedTaskIndex !== null) {
                // Determine the other task in the comparison
                const otherTaskIndex = heartedTaskIndex === 0 ? 1 : 0; // Switch the index to get the other task
                const otherTask = chosenTask[otherTaskIndex]; // Retrieve the other task from the current comparison

                // Only adjust score for the hearted task if it's the other task
                if (otherTask === chosenTask[otherTaskIndex]) {
                    results[otherTask] = results[otherTask] ? results[otherTask] + 0.1 : 0.1;
                }
            }

            // Then adjust the score for the chosen task
            results[chosenTask] = results[chosenTask] ? results[chosenTask] + 0.1 : 0.1;

            // Reset heartedTaskIndex after each comparison
            heartedTaskIndex = null;
            startTiebreakerComparison();
            // updateScoresDisplay();
        }

        function finalizeResultsDisplay(sortedTasks) {
            exitTiePhase();
            document.getElementById('comparisonSection').style.display = 'none';
            const resultsSection = document.getElementById('resultsSection');
            let leaderboardHTML = '<h3>High Scores</h3>';
            leaderboardHTML += '<div class="mt-3 leaderboard">';
            sortedTasks.forEach((task, index) => {
                //GPT ADDS: Generate filled hearts based on the heart count for each task
                const heartCount = heartCounts[task[0]] || 0; // Default to 0 if no hearts
                let heartsHTML = '';
                for (let i = 0; i < heartCount; i++) {
                    heartsHTML += '<img src="./img/heart-fill.png" width="24" height="24">';
                }

                leaderboardHTML += `
            <div class="leaderboard-row ${index === 0 ? 'leaderboard-top' : ''}">
                <span class="leaderboard-rank">${index + 1}</span>
                <span class="leaderboard-name">${task[0]}</span>
                <span class="leaderboard-hearts">${heartsHTML}</span>
                <span class="leaderboard-score">${task[1].toFixed(2)}</span>
            </div>
           `;
            });
            leaderboardHTML += '</div>';
            resultsSection.innerHTML = leaderboardHTML;
            let resetButtonHTML = '<button id="resetButton" class="mt-3 btn brutalButton" style="width: 100%;" onclick="resetComparisons()">Reset</button>';
            // Append the reset button HTML to the resultsSection or another appropriate section based on your layout
            resultsSection.innerHTML += resetButtonHTML;
        }

        document.getElementById('compareButton').style.display = 'block';

        function updateCompareButtonVisibility() {
            const compareButton = document.getElementById('compareButton');
            compareButton.style.display = tasks.length >= 2 ? 'block' : 'none';
        }

        document.getElementById('compareButton').style.display = 'none';

        document.addEventListener('change', function (event) {
            if (event.target.classList.contains('preference-checkbox')) {
                //GPT ADDS: Deselect other checkboxes if this one is checked
                if (event.target.checked) {
                    document.querySelectorAll('.preference-checkbox').forEach(function (checkbox) {
                        // Ensure we're only affecting other checkboxes
                        if (checkbox !== event.target) {
                            checkbox.checked = false; // Deselect all other checkboxes
                        }
                    });
                }
                //GPT ADDS: Check which checkbox is selected to update the heartedTaskIndex
                const heartedTaskIndex = event.target.id === 'prefLeft' ? 0 : 1;
                // Only proceed if the checkbox is checked
                if (event.target.checked) {
                    const chosenTask = comparisons[comparisonIndex][heartedTaskIndex];
                    if (!heartCounts[chosenTask]) {
                        heartCounts[chosenTask] = 1; // Initialize with 1 if it does not exist
                    } else {
                        heartCounts[chosenTask]++; // Increment if already exists
                    }
                }
            }
        });

        // function updateScoresDisplay() {
        //     const scoresSection = document.getElementById('scoresSection');
        //     // Start with an empty string or a basic message
        //     let scoresHTML = '<h3>Current Scores</h3><div class="leaderboard">';
        //     // Iterate through the results object to append each task's score
        //     Object.entries(results).forEach(([task, score], index) => {
        //         scoresHTML += `
        //         <div class="leaderboard-row">
        //             <span class="leaderboard-name">${task}</span>
        //             <span class="leaderboard-score">${score.toFixed(2)}</span>
        //         </div>
        //     `;
        //     });
        //     scoresHTML += '</div>';
        //     scoresSection.innerHTML = scoresHTML;
        // }

    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM"
        crossorigin="anonymous"></script>
</body>

</html>