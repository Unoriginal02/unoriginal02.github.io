<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Blind Timer</title>
    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=JetBrains+Mono&display=swap"
        rel="stylesheet">

    <style>
        body {
            background-color: #000000;
            /* Dark background */
            color: #f8f9fa;
            /* Light text color */
        }

        h1 {
            font-family: 'Bebas Neue', sans-serif;
            text-align: center;
        }

        #countdown-display {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 128px;
            text-align: center;
            /* Center the countdown display */
            margin-top: 0;
            /* Remove the top margin to place it at the top */
            color: #eeeeee;
        }

        .content-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100vh;
        }

        .content-group {
            width: 100%;
            max-width: 640px;
        }

        .shaking {
            animation: shake 0.3s infinite;
        }

        @keyframes shake {
            0% {
                transform: translate(1px, 1px) rotate(0deg);
            }

            10% {
                transform: translate(-1px, -2px) rotate(-1deg);
            }

            20% {
                transform: translate(-3px, 0px) rotate(1deg);
            }

            30% {
                transform: translate(3px, 2px) rotate(0deg);
            }

            40% {
                transform: translate(1px, -1px) rotate(1deg);
            }

            50% {
                transform: translate(-1px, 2px) rotate(-1deg);
            }

            60% {
                transform: translate(-3px, 1px) rotate(0deg);
            }

            70% {
                transform: translate(3px, 1px) rotate(-1deg);
            }

            80% {
                transform: translate(-1px, -1px) rotate(1deg);
            }

            90% {
                transform: translate(1px, 2px) rotate(0deg);
            }

            100% {
                transform: translate(1px, -2px) rotate(-1deg);
            }
        }

        #time-grid {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fill, 4px);
            /* Adjust to fit 4x4px squares */
            grid-gap: 4px;
            /* Gap of 2px between squares */
            justify-content: center;
            /* Center grid items */
        }

        .time-square {
            width: 4px;
            height: 4px;
            background-color: #eeeeee;
            /* Very light gray */
            margin: 1px;
            /* Gap of 2px between squares */
        }


        .time-square.yellow {
            background-color: #ffc107;
            /* Bootstrap orange */
        }

        .time-square.red {
            background-color: #dc3545;
            /* Bootstrap red */
        }

        .content-wrapper {
            display: flex;
            height: 100%;
            border: 0px solid #eeeeee;
            margin: 0;
            padding: 0;
            align-items: center;
            justify-content: center;
        }

        .button-wrapper {
            display: flex;
            justify-content: stretch;
        }


        .brutalButton {
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid #eeeeee;
            background-color: #000000;
            color: #eeeeee;
            flex: 1;
            /* Flex grow to fill available space */
            margin-right: -1px;
            /* Overlap borders */
            padding: .5rem 0;
        }

        .brutalButton:hover {
            background-color: #222222;
        }

        .brutalButton:last-child {
            margin-right: 0;
        }

        .brutalInput {
            font-family: 'JetBrains Mono', monospace;
            border: 1px solid #eeeeee;
            background-color: #000000;
            color: #eeeeee;
            padding: .5rem .5rem;
            height: 42px;
            margin-right: -1px;
            /* Overlap borders */
            border-radius: 0;
            text-align: center;
        }

        button:focus {
            /* outline: 1px dotted; */
            outline: 0px auto -webkit-focus-ring-color;
            background-color: rgba(255, 255, 255, .1);
        }

        .form-control:focus {
            background-color: rgba(255, 255, 255, .1) !important;
            border-color: #eeeeee;
            outline: 0;
            box-shadow: none;
        }

        .brutalInput:focus {
            background-color: #333333;
            color: #eeeeee;
            /* Change text color to light gray when focused */
            outline: none;
            /* Remove the default focus outline */
        }

        .brutalInput::placeholder {
            /* Change the color of placeholders */
            color: #bbbbbb;
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 100%;
            }
        }

        @media (min-width: 540px) {
            #time-grid {
                width: 100%;
                display: grid;
                grid-template-columns: repeat(auto-fill, 6px);
                /* Adjust to fit 4x4px squares */
                grid-gap: 4px;
                /* Gap of 2px between squares */
                justify-content: center;
                /* Center grid items */
            }

            .time-square {
                width: 6px;
                height: 6px;
                background-color: #eeeeee;
                /* Very light gray */
                margin: 1px;
                /* Gap of 2px between squares */
            }

            .content-wrapper {
                display: flex;
                height: 100%;
                border: 1px solid #eeeeee;
                margin: 2rem 1rem;
                padding: 2rem;
                align-items: center;
                justify-content: center;
            }
        }

        .marginAdjust {
            margin-top: -1px;
        }

        .upwardClass {
            font-family: 'JetBrains Mono', monospace;
        }

        .check {
            padding: 10px;
            background-color: red;
        }
    </style>
</head>

<body>

    <div class="container content-container">
        <div class="content-wrapper">
            <div class="justify-content-center content-group">
                <div class="text-center">
                    <div id="input-group">
                        <div id="base-time-inputs-container">
                            <div class="d-flex justify-content-center">
                                <input type="number" id="hours-input" class="form-control brutalInput"
                                    placeholder="Hours" min="0" required>
                                <input type="number" id="minutes-input" class="form-control brutalInput"
                                    placeholder="Minutes" min="0" required>
                            </div>
                            <div class="" id="time-inputs-container">
                                <!-- Sub-timers added here -->
                            </div>
                        </div>
                        <div class="button-wrapper marginAdjust">
                            <button id="add-time-button" class="brutalButton">Add Time</button>
                            <button id="start-button" class="brutalButton">Start</button>
                        </div>
                    </div>
                    <div id="countdown-group" style="display: none;">
                        <div id="time-grid" class="">
                            <!-- Squares will be added dynamically using JavaScript -->
                        </div>
                        <div id="countdown-display" class="mt-3"></div>
                        <div id="upward-timer" style="display: none; font-size: 32px; text-align: center;"
                            class="mb-3 upwardClass">
                        </div>
                        <div class="button-wrapper">
                            <button id="pause-button" class="brutalButton">Pause</button>
                            <button id="reset-button" class="brutalButton">Reset</button>
                            <!-- <button id="checkpoint-button" class="brutalButton">Checkpoint</button> -->
                        </div>
                        <div id="checkpoint-form" style="display: none;" class="marginAdjust">
                            <div class="d-flex justify-content-center">
                                <input type="number" id="checkpoint-hours-input" class="form-control brutalInput"
                                    placeholder="Hours" min="0">
                                <input type="number" id="checkpoint-minutes-input" class="form-control brutalInput"
                                    placeholder="Minutes" min="0">
                            </div>
                            <div class="d-flex justify-content-center marginAdjust">
                                <button id="set-checkpoint-button" class="brutalButton">Set Checkpoint</button>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let countdown;
        let endTime;
        let originalSeconds; // Declare originalSeconds
        let isPaused = false;
        let upwardTimerInterval;
        let upwardStartTime;

        // Function to simulate button click
        function simulateButtonClick(buttonId) {
            document.getElementById(buttonId).click();
        }

        let isSubtimerActive = false;

        document.getElementById('add-time-button').addEventListener('click', function () {
            var container = document.getElementById('time-inputs-container');
            var newInputGroup = document.createElement('div');
            newInputGroup.className = 'd-flex justify-content-center';
            newInputGroup.innerHTML = `
                <input type="number" class="form-control brutalInput marginAdjust" placeholder="Hours" min="0">
                <input type="number" class="form-control brutalInput marginAdjust" placeholder="Minutes" min="0">
            `;
            container.appendChild(newInputGroup);
            // Set isSubtimerActive to true when a new subtimer is added
            isSubtimerActive = true;
            localStorage.setItem('isSubtimerActive', isSubtimerActive.toString());
            console.log('(add)isSubtimerActive:', isSubtimerActive);
        });


        // // Add event listener to start timer inputs
        // document.getElementById('hours-input').addEventListener('keyup', function (event) {
        //     if (event.keyCode === 13) { // 13 is the Enter key
        //         simulateButtonClick('start-button');
        //     }
        // });

        // document.getElementById('minutes-input').addEventListener('keyup', function (event) {
        //     if (event.keyCode === 13) {
        //         simulateButtonClick('start-button');
        //     }
        // });

        // // Add event listener to set checkpoint inputs
        // document.getElementById('checkpoint-hours-input').addEventListener('keyup', function (event) {
        //     if (event.keyCode === 13) {
        //         simulateButtonClick('set-checkpoint-button');
        //     }
        // });

        // document.getElementById('checkpoint-minutes-input').addEventListener('keyup', function (event) {
        //     if (event.keyCode === 13) {
        //         simulateButtonClick('set-checkpoint-button');
        //     }
        // });


        document.addEventListener('DOMContentLoaded', function () {
            console.log("DOMContentLoaded event triggered");

            if (localStorage.getItem("endTime")) {
                endTime = parseInt(localStorage.getItem("endTime"));
                originalSeconds = parseInt(localStorage.getItem("originalSeconds"));
                isPaused = localStorage.getItem("isPaused") === "true";
                remainingTime = isPaused ? parseInt(localStorage.getItem("remainingTime")) : 0;

                console.log("Retrieved endTime:", endTime, "originalSeconds:", originalSeconds);

                initializeTimeGrid(originalSeconds); // This ensures grid is set up

                toggleVisibility();

                if (isPaused) {
                    let currentTime = Date.now();
                    endTime = currentTime + remainingTime;
                    startCountdown();
                    document.getElementById("pause-button").textContent = "Pause";
                    isPaused = false;
                    localStorage.setItem("isPaused", isPaused.toString());
                } else {
                    startCountdown();
                }

                // Delay the application of colors to ensure the squares are ready
                setTimeout(() => {
                    const savedColors = JSON.parse(localStorage.getItem('squareColors') || '[]');
                    console.log("Retrieved colors from localStorage:", savedColors); // Add this line
                    document.querySelectorAll('.time-square').forEach((square, index) => {
                        const color = savedColors[index];
                        if (color) {
                            square.style.backgroundColor = color;
                        }
                    });
                }, 100); // delay of 100ms
            }

            // Apply saved colors after initializing the grid
            const savedColors = JSON.parse(localStorage.getItem('squareColors') || '[]');
            // document.querySelectorAll('.time-square').forEach((square, index) => {
            //     const color = savedColors[index];
            //     if (color) {
            //         square.style.backgroundColor = color;
            //     }
            // });

            if (localStorage.getItem("gridState")) {
                const gridState = JSON.parse(localStorage.getItem("gridState"));
                document.querySelectorAll(".time-square").forEach((square, index) => {
                    if (gridState[index]) {
                        square.style.backgroundColor = gridState[index];
                    }
                });
            }

            if (localStorage.getItem("upwardStartTime")) {
                upwardStartTime = parseInt(localStorage.getItem("upwardStartTime"));
                startUpwardTimer();
            }

            if (localStorage.getItem("checkpointSeconds")) {
                paintCheckpointSquares(parseInt(localStorage.getItem("checkpointSeconds")));
            }

            // Retrieve and initialize isSubtimerActive
            isSubtimerActive = localStorage.getItem('isSubtimerActive') === 'true';

            // Add event delegation to handle 'Enter' key for dynamically added inputs
            document.getElementById('base-time-inputs-container').addEventListener('keyup', function (event) {
                if (event.target.matches('input') && event.keyCode === 13) { // Check if the event target is an input and the key is Enter
                    simulateButtonClick('start-button');
                }
            });
        });

        document.getElementById('start-button').addEventListener('click', function () {
            let totalDuration = 0;

            // Only add main timer duration once
            let mainHours = parseInt(document.getElementById('hours-input').value) || 0;
            let mainMinutes = parseInt(document.getElementById('minutes-input').value) || 0;
            let mainDuration = mainHours * 3600 + mainMinutes * 60;
            // totalDuration += mainDuration; // Add main timer duration

            // Add durations of all sub-timers
            document.querySelectorAll('#time-inputs-container > div').forEach((div) => {
                let hours = parseInt(div.querySelector('input:first-child').value) || 0;
                let minutes = parseInt(div.querySelector('input:last-child').value) || 0;
                totalDuration += hours * 3600 + minutes * 60; // Add each sub-timer duration
            });

            totalDuration += mainDuration;
            console.log('totalduration::', totalDuration);
            console.log('Main Duration::', mainDuration)

            originalSeconds = totalDuration; // Set originalSeconds here
            endTime = Date.now() + totalDuration * 1000;

            initializeTimeGrid(totalDuration); // Initialize the grid with mainDuration
            toggleVisibility();
            startCountdown();

            localStorage.setItem('endTime', endTime.toString());
            localStorage.setItem('originalSeconds', originalSeconds.toString());
            localStorage.setItem('isPaused', 'false');
            console.log('(start)isSubtimerActive:', isSubtimerActive);
        });

        function getRandomColor() {
            const neonColors = [
                '#FF355E', // Neon Red
                '#FD5B78', // Neon Pink
                '#FF6037', // Neon Orange
                '#FF9966', // Neon Peach
                '#FFCC33', // Neon Yellow
                '#CCFF00', // Neon Green
                '#66FF66', // Neon Lime Green
                '#AAF0D1', // Neon Mint Green
                '#50BFE6', // Neon Blue
                '#FF6EFF', // Neon Purple
                '#EE34D2', // Neon Magenta
                '#FF00CC'  // Neon Fuchsia
            ];

            // Check if all colors have been used
            if (usedColors.length === neonColors.length) {
                usedColors = []; // Reset the list if all colors have been used
            }

            let randomColor;
            do {
                // Select a random index from the neonColors array
                const randomIndex = Math.floor(Math.random() * neonColors.length);
                randomColor = neonColors[randomIndex];
            } while (usedColors.includes(randomColor)); // Ensure the color hasn't been used already

            usedColors.push(randomColor); // Add the selected color to the list of used colors
            return randomColor;
        }

        // Initialize an array to keep track of used colors
        let usedColors = [];

        document.getElementById('pause-button').addEventListener('click', function () {
            if (isPaused) {
                // Resume the countdown
                endTime = Date.now() + remainingTime;
                startCountdown();
                this.textContent = 'Pause';
                isPaused = false;
            } else {
                // Pause the countdown
                clearInterval(countdown);
                remainingTime = endTime - Date.now(); // Save remaining time
                this.textContent = 'Resume';
                isPaused = true;
                localStorage.setItem('remainingTime', remainingTime.toString()); // Save remaining time
            }
            localStorage.setItem('isPaused', isPaused.toString());
        });


        document.getElementById('reset-button').addEventListener('click', function () {
            clearInterval(countdown);
            toggleVisibility();
            localStorage.clear(); // Clear local storage on reset

            clearInterval(upwardTimerInterval); // Stop the upward timer
            upwardStartTime = null; // Reset upwardStartTime to null
            document.getElementById('upward-timer').style.display = 'none';
            document.getElementById('upward-timer').textContent = '00:00:00'; // Reset the upward timer display

            let countdownDisplay = document.getElementById('countdown-display');
            countdownDisplay.style.fontSize = '128px'; // Reset font size
            countdownDisplay.style.marginTop = '0'; // Reset margin

            // Reset initial form values
            document.getElementById('hours-input').value = '';
            document.getElementById('minutes-input').value = '';

            // Reset checkpoint form values as well
            document.getElementById('checkpoint-hours-input').value = '';
            document.getElementById('checkpoint-minutes-input').value = '';

            //Clear all dynamically added time input groups
            var timeInputsContainer = document.getElementById('time-inputs-container');
            timeInputsContainer.innerHTML = ''; // Clear all child elements
            isSubtimerActive = false;
            localStorage.setItem('isSubtimerActive', isSubtimerActive.toString());
            console.log('(reset)isSubtimerActive:', isSubtimerActive);

            // Reset the pause button's text to "Pause" and reset the isPaused flag
            document.getElementById('pause-button').textContent = 'Pause';
            isPaused = false;
            localStorage.setItem('isPaused', 'false'); // Update the isPaused flag in localStorage

        });



        function startCountdown() {
            countdown = setInterval(function () {
                let totalSeconds = Math.round((endTime - Date.now()) / 1000);
                updateDisplay(totalSeconds);

                if (totalSeconds <= 0) {
                    clearInterval(countdown);
                    let countdownDisplay = document.getElementById('countdown-display');
                    countdownDisplay.textContent = 'â°';
                    countdownDisplay.style.fontSize = '64px'; // Reduced font size
                    countdownDisplay.style.marginTop = '16px'; // Reduced font size
                    animateGrid();
                }
                localStorage.setItem('endTime', endTime.toString());
            }, 1000);
        }

        function initializeTimeGrid(totalDuration) {
            const grid = document.getElementById('time-grid');
            grid.innerHTML = ''; // Clear existing squares if any

            //Check if there are already saved colors in localStorage
            const savedColors = JSON.parse(localStorage.getItem('squareColors') || '[]');
            let colorsNeedSaving = savedColors.length === 0;

            //Log to check if the grid is initialized correctly
            console.log("Initializing grid for duration:", totalDuration);

            // Add squares for the total duration
            let mainSquares = calculateTotalSquares(totalDuration);
            for (let i = 0; i < mainSquares; i++) {
                const square = document.createElement('div');
                square.classList.add('time-square');
                grid.appendChild(square);
            }

            //Collect durations from sub-timers to calculate the starting index for coloring
            let durations = Array.from(document.querySelectorAll('#time-inputs-container > div')).map(div => {
                let hours = parseInt(div.querySelector('input:first-child').value) || 0;
                let minutes = parseInt(div.querySelector('input:last-child').value) || 0;
                return hours * 3600 + minutes * 60;
            });

            //Reverse durations to start coloring from the bottom
            durations.reverse();

            //Modified logic to calculate the number of squares for each sub-timer based on total duration
            let subTimerEndIndex = mainSquares; // Start from the end of the grid
            durations.forEach(duration => {
                // Recalculate the number of squares for this sub-timer
                let subSquares = calculateSubTimerSquares(duration, totalDuration);
                let color = getRandomColor();

                // Color squares for this sub-timer
                for (let i = subTimerEndIndex - 1; i >= subTimerEndIndex - subSquares && i >= 0; i--) {
                    grid.children[i].style.backgroundColor = color;
                }
                subTimerEndIndex -= subSquares; // Move the index down for the next sub-timer
            });



            if (colorsNeedSaving) {
                // Only save colors if they haven't been saved before
                const colors = Array.from(document.querySelectorAll('.time-square')).map(square => square.style.backgroundColor);
                localStorage.setItem('squareColors', JSON.stringify(colors));
                console.log("Colors saved to localStorage:", colors);
            }
        }

        function calculateSubTimerSquares(subTimerDuration, totalDuration) {
            //Calculate the number of squares for a sub-timer based on the total duration
            let durationRatio = subTimerDuration / totalDuration;
            let totalSquares = calculateTotalSquares(totalDuration);
            return Math.ceil(totalSquares * durationRatio);
        }


        function calculateTotalSquares(duration) {
            if (duration > 7200) { // If duration is greater than 2 hours
                return Math.ceil(duration / 8); // One square every 8 seconds
            } else if (duration > 3600) {
                return Math.ceil(duration / 4); // Quarter the squares for durations greater than 1 hour
            } else if (duration > 1800) {
                return Math.ceil(duration / 2); // Half the squares for durations greater than 30 minutes
            } else {
                return duration;
            }
        }

        function updateDisplay(totalSeconds) {
            let countdownDisplay = document.getElementById('countdown-display');
            countdownDisplay.className = ''; // Reset classes

            // Update countdown display color based on remaining percentage
            let percentage = totalSeconds / originalSeconds;
            updateCountdownDisplayColor(countdownDisplay, percentage);
            countdownDisplay.textContent = totalSeconds <= 0 ? 0 : totalSeconds; // Display 0 when time is up

            // Update time grid colors
            updateTimeGridColors(totalSeconds, percentage);
            updateTimerColor(totalSeconds);
        }

        function updateCountdownDisplayColor(display, percentage) {
            // let checkpointSeconds = parseInt(localStorage.getItem('checkpointSeconds') || '0');
            // let isCheckpointActive = checkpointSeconds > 0;

            display.classList.remove('text-warning', 'text-danger', 'shaking');
            if (!isSubtimerActive) {
                // console.log("No checkpoint active, should update to orange/red if necessary.");
                if (percentage > 0.5) {
                    // Normal state
                } else if (percentage > 0.25) {
                    display.classList.add('text-warning');
                } else if (percentage > 0.05) {
                    display.classList.add('text-danger');
                } else {
                    display.classList.add('text-danger', 'shaking');
                }
            } else {
                // console.log("Checkpoint active, updating squares for checkpoint.");
            }
        }

        function updateTimeGridColors(totalSeconds, percentage) {
            let checkpointSeconds = parseInt(localStorage.getItem('checkpointSeconds') || '0');
            let isCheckpointActive = checkpointSeconds > 0;

            let totalSquares = calculateTotalSquares(originalSeconds);
            let elapsedSquares;

            if (originalSeconds > 7200) {
                elapsedSquares = Math.ceil((originalSeconds - totalSeconds) / 8);
            } else if (originalSeconds > 3600) {
                elapsedSquares = Math.ceil((originalSeconds - totalSeconds) / 4);
            } else if (originalSeconds > 1800) {
                elapsedSquares = Math.ceil((originalSeconds - totalSeconds) / 2);
            } else {
                elapsedSquares = originalSeconds - totalSeconds;
            }

            const squares = document.querySelectorAll('.time-square');
            squares.forEach((square, index) => {
                // Reset color classes and opacity
                square.classList.remove('yellow', 'red');
                square.style.opacity = index < elapsedSquares ? '0.4' : '1';

                // Update square color based on remaining percentage and checkpoint status
                if (!isSubtimerActive) {
                    // console.log("No checkpoint active, should update to orange/red if necessary.");
                    if (percentage > 0.5) {
                        // Normal state, no color change
                    } else if (percentage > 0.25) {
                        if (index >= elapsedSquares) square.classList.add('yellow');
                    } else {
                        if (index >= elapsedSquares) square.classList.add('red');
                    }
                } else {
                    // console.log("Checkpoint active, updating squares for checkpoint.");
                }
            });
        }

        function toggleVisibility() {
            var inputGroup = document.getElementById('input-group');
            var countdownGroup = document.getElementById('countdown-group');

            if (inputGroup.style.display === 'none') {
                inputGroup.style.display = 'block';
                countdownGroup.style.display = 'none';
            } else {
                inputGroup.style.display = 'none';
                countdownGroup.style.display = 'block';
            }
        }

        function animateGrid() {
            const squares = document.querySelectorAll('.time-square');
            const interval = 1000; // Interval in milliseconds for the color change effect

            setInterval(() => {
                // Reset all squares to their original color and set opacity to 1
                squares.forEach(sq => {
                    sq.style.backgroundColor = '#5F5F5F'; // Original color
                    sq.style.opacity = '1'; // Full opacity
                });

                // Randomly select squares and change their color
                for (let i = 0; i < squares.length; i++) {
                    if (Math.random() < 0.25) { // Adjust the probability as needed
                        // Generate a random color
                        const randomColor = '#' + Math.floor(Math.random() * 16777215).toString(16);

                        // Apply color change with full opacity
                        squares[i].style.transition = 'background-color 0.25s';
                        squares[i].style.backgroundColor = randomColor;
                        squares[i].style.opacity = '1'; // Ensure full opacity for color change
                    }
                }
            }, interval);
            startUpwardTimer();
        }


        function startUpwardTimer() {
            let currentTime = Date.now();

            if (!upwardStartTime) {
                // Check if the countdown has already finished while the script was inactive
                if (endTime && currentTime > endTime) {
                    // Calculate the time elapsed since the countdown finished
                    let elapsedSinceEnd = currentTime - endTime;
                    // Set the upwardStartTime to a past time reflecting the countdown end
                    upwardStartTime = currentTime - elapsedSinceEnd;
                } else {
                    // If the countdown hasn't finished, start the upward timer normally
                    upwardStartTime = currentTime;
                }
            }

            upwardTimerInterval = setInterval(function () {
                updateUpwardTimer();
            }, 1000);

            document.getElementById('upward-timer').style.display = 'block';
            localStorage.setItem('upwardStartTime', upwardStartTime.toString());
        }

        function updateUpwardTimer() {
            let elapsed = Date.now() - upwardStartTime;
            let hours = Math.floor(elapsed / 3600000);
            let minutes = Math.floor((elapsed % 3600000) / 60000);
            let seconds = Math.floor((elapsed % 60000) / 1000);

            document.getElementById('upward-timer').textContent =
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        document.getElementById('checkpoint-button').addEventListener('click', function () {
            document.getElementById('checkpoint-form').style.display = 'block';
            // Reset checkpoint form values
            document.getElementById('checkpoint-hours-input').value = '';
            document.getElementById('checkpoint-minutes-input').value = '';
        });

        document.getElementById('set-checkpoint-button').addEventListener('click', function () {
            var checkpointHours = parseInt(document.getElementById('checkpoint-hours-input').value) || 0;
            var checkpointMinutes = parseInt(document.getElementById('checkpoint-minutes-input').value) || 0;
            var checkpointSeconds = checkpointHours * 3600 + checkpointMinutes * 60;

            paintCheckpointSquares(checkpointSeconds);
            document.getElementById('checkpoint-form').style.display = 'none';
        });

        function paintCheckpointSquares(checkpointSeconds) {
            let totalSquares = calculateTotalSquares(originalSeconds);
            let checkpointSquaresRate = originalSeconds > 7200 ? 8 : originalSeconds > 3600 ? 4 : originalSeconds > 1800 ? 2 : 1;
            let checkpointSquares = Math.ceil(checkpointSeconds / checkpointSquaresRate);
            let startSquare = totalSquares - checkpointSquares;

            const squares = document.querySelectorAll('.time-square');
            const gridState = new Array(squares.length).fill('');

            // Reset all squares to white (original color)
            squares.forEach(square => {
                square.style.backgroundColor = 'white'; // Set to original color
            });

            // Apply new checkpoint coloring from the calculated start square
            for (let i = startSquare; i < totalSquares; i++) {
                squares[i].style.backgroundColor = '#00a8e8';
                gridState[i] = '#00a8e8'; // Save the new checkpoint state
            }

            // Save the updated checkpoint state
            localStorage.setItem('gridState', JSON.stringify(gridState));
            localStorage.setItem('checkpointSeconds', checkpointSeconds.toString());
        }

        function updateTimerColor(totalSeconds) {
            const squares = document.querySelectorAll('.time-square');
            let countdownDisplay = document.getElementById('countdown-display');
            let elapsedSquares = calculateElapsedSquares(originalSeconds, totalSeconds);

            // Check if the elapsed time has reached the subtimer squares
            if (elapsedSquares < squares.length) {
                let currentSquare = squares[elapsedSquares];
                // If the current square is a subtimer square (not white and not empty), update the color
                if (currentSquare.style.backgroundColor !== '' && currentSquare.style.backgroundColor !== 'white') {
                    countdownDisplay.style.color = currentSquare.style.backgroundColor;
                } else {
                    // Default color if no special subtimer is active
                    countdownDisplay.style.color = '#ffffff'; // White color
                }
            } else {
                // Default color if the time has elapsed beyond the grid
                countdownDisplay.style.color = '#ffffff'; // White color
            }
        }

        function calculateElapsedSquares(originalSeconds, totalSeconds) {
            if (originalSeconds > 7200) {
                return Math.ceil((originalSeconds - totalSeconds) / 8);
            } else if (originalSeconds > 3600) {
                return Math.ceil((originalSeconds - totalSeconds) / 4);
            } else if (originalSeconds > 1800) {
                return Math.ceil((originalSeconds - totalSeconds) / 2);
            } else {
                return originalSeconds - totalSeconds;
            }
        }
    </script>

</body>

</html>