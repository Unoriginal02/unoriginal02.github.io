<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Time Blind Timer</title>
    <!-- Bootstrap CSS CDN -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&display=swap" rel="stylesheet">
    <style>

        body {
            background-color: #222222; /* Dark background */
            color: #f8f9fa; /* Light text color */
        }
        h1 {
            font-family: 'Bebas Neue', sans-serif;
            text-align: center;
        }
        #countdown-display {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 128px;
            text-align: center; /* Center the countdown display */
            margin-top: 0; /* Remove the top margin to place it at the top */
            color: #eeeeee;
        }
        .content-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            height: 100vh;
        }
        .content-group {
            width: 100%;
            max-width: 640px;
        }
        .shaking {
            animation: shake 0.3s infinite;
        }
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }
        #time-grid {
            width: 100%;
            display: grid;
            grid-template-columns: repeat(auto-fill, 4px); /* Adjust to fit 4x4px squares */
            grid-gap: 4px; /* Gap of 2px between squares */
            justify-content: center; /* Center grid items */
        }

        .time-square {
            width: 4px;
            height: 4px;
            background-color: #eeeeee; /* Very light gray */
            margin: 1px; /* Gap of 2px between squares */
        }


        .time-square.yellow {
            background-color: #ffc107; /* Bootstrap orange */
        }

        .time-square.red {
            background-color: #dc3545; /* Bootstrap red */
        }

        .content-wrapper{
            display: flex;
            height: 100%;
            border: 0px solid #eeeeee;
            margin:  0;
            padding: 0;
            align-items: center;
            justify-content: center;
        }

        .button-wrapper {
            display: flex;
            justify-content: stretch;
        }


        .brutalButton {
            border: 1px solid #eeeeee;
            background-color: #222222;
            color: #eeeeee;
            flex: 1; /* Flex grow to fill available space */
            margin-right: -1px; /* Overlap borders */
            padding: .5rem 0; 
        }

        .brutalButton:hover{
            background-color: #333333;
        }        

        .brutalButton:last-child {
             margin-right: 0;
        }

        .brutalInput {
            border: 1px solid #eeeeee;
            background-color: #222222;
            color: #eeeeee;
            padding: .5rem .5rem;
            height: 42px;
            margin-right: -1px; /* Overlap borders */
            border-radius: 0; 
        }

        .brutalInput:focus {
            background-color: #333333;
            color: #eeeeee; /* Change text color to light gray when focused */
            outline: none; /* Remove the default focus outline */
        }

        .brutalInput::placeholder { /* Change the color of placeholders */
            color: #bbbbbb;
        }

        @media (min-width: 1200px) {
            .container {
                max-width: 100%;
            }
        }

        @media (min-width: 540px) {
            #time-grid {
                width: 100%;
                display: grid;
                grid-template-columns: repeat(auto-fill, 6px); /* Adjust to fit 4x4px squares */
                grid-gap: 4px; /* Gap of 2px between squares */
                justify-content: center; /* Center grid items */
            }

            .time-square {
                width: 6px;
                height: 6px;
                background-color: #eeeeee; /* Very light gray */
                margin: 1px; /* Gap of 2px between squares */
            }

            .content-wrapper{
                display: flex;
                height: 100%;
                border: 1px solid #eeeeee;
                margin: 2rem 1rem;
                padding: 2rem;
                align-items: center;
                justify-content: center;
            }


        }

    </style>
</head>
<body>
    
    <div class="container content-container">
        <div class="content-wrapper">
            <div class="justify-content-center content-group">
                <div class="text-center">
                    <div id="input-group">
                        <div class="d-flex justify-content-center">
                            <input type="number" id="hours-input" class="form-control brutalInput" placeholder="Hours" min="0"  required>
                            <input type="number" id="minutes-input" class="form-control brutalInput" placeholder="Minutes" min="0" required>
                        </div>
                        <div class="button-wrapper">
                            <button id="start-button" class="brutalButton mt-3">Start</button>
                        </div>
                    </div>
                    <div id="countdown-group" style="display: none;">
                        <div id="time-grid" class="">
                            <!-- Squares will be added dynamically using JavaScript -->
                        </div>
                        <div id="countdown-display" class="mt-3"></div>
                        <div class="button-wrapper">
                            <button id="pause-button" class="brutalButton">Pause</button>
                            <button id="reset-button" class="brutalButton">Reset</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>

        // Add this at the beginning of your script
        document.addEventListener('DOMContentLoaded', function() {
            if (localStorage.getItem('endTime')) {
                endTime = parseInt(localStorage.getItem('endTime'));
                originalSeconds = parseInt(localStorage.getItem('originalSeconds'));
                isPaused = localStorage.getItem('isPaused') === 'true';
                toggleVisibility();
                if (!isPaused) {
                    startCountdown();
                } else {
                    let remainingTime = endTime - Date.now();
                    updateDisplay(Math.round(remainingTime / 1000));
                    document.getElementById('pause-button').textContent = 'Resume';
                    document.getElementById('pause-button').className = 'brutalButton';
                }
            }

            if (localStorage.getItem('gridState')) {
                    initializeTimeGrid();
                    const savedGridState = JSON.parse(localStorage.getItem('gridState'));
                    const squares = document.querySelectorAll('.time-square');
                    squares.forEach((square, index) => {
                        if (savedGridState[index]) {
                            square.style.backgroundColor = savedGridState[index];
                        }
                    });
            }           
        });

        let countdown;
        let endTime;
        let originalSeconds; // Declare originalSeconds
        let isPaused = false;

        document.getElementById('start-button').addEventListener('click', function() {
            var hours = parseInt(document.getElementById('hours-input').value) || 0;
            var minutes = parseInt(document.getElementById('minutes-input').value) || 0;
            let duration = hours * 3600 + minutes * 60;
            originalSeconds = duration; // Set originalSeconds here
            endTime = Date.now() + duration * 1000;

            initializeTimeGrid(); // Initialize the grid
            toggleVisibility();
            startCountdown();

            localStorage.setItem('endTime', endTime.toString());
            localStorage.setItem('originalSeconds', originalSeconds.toString());
            localStorage.setItem('isPaused', 'false');
        });

        document.getElementById('pause-button').addEventListener('click', function() {
            if (isPaused) {
                let remainingTime = endTime - Date.now();
                endTime = Date.now() + remainingTime;
                startCountdown();
                this.textContent = 'Pause';
                this.className = 'brutalButton';
                isPaused = false;
            } else {
                clearInterval(countdown);
                this.textContent = 'Resume';
                this.className = 'brutalButton';
                isPaused = true;
            }
            localStorage.setItem('isPaused', isPaused.toString());
        });

        document.getElementById('reset-button').addEventListener('click', function() {
            clearInterval(countdown);
            toggleVisibility();
            localStorage.clear(); // Clear local storage on reset
        });

        function startCountdown() {
            countdown = setInterval(function() {
                let totalSeconds = Math.round((endTime - Date.now()) / 1000);
                updateDisplay(totalSeconds);

                if (totalSeconds <= 0) {
                    clearInterval(countdown);
                    document.getElementById('countdown-display').textContent = '⏰';
                    animateGrid();
                }
                localStorage.setItem('endTime', endTime.toString());
            }, 1000);
        }

        function initializeTimeGrid() {
            const grid = document.getElementById('time-grid');
            grid.innerHTML = ''; // Clear existing squares if any
            let totalSquares = originalSeconds; // Default value for totalSquares

            if (localStorage.getItem('gridState')) {
                totalSquares = JSON.parse(localStorage.getItem('gridState')).length;
            }

            for (let i = 0; i < totalSquares; i++) {
                const square = document.createElement('div');
                square.classList.add('time-square');
                grid.appendChild(square);
            }
        }

        function updateDisplay(totalSeconds) {
            let countdownDisplay = document.getElementById('countdown-display');
            countdownDisplay.className = ''; // Reset classes

            // Update countdown display color based on remaining percentage
            let percentage = totalSeconds / originalSeconds;
            updateCountdownDisplayColor(countdownDisplay, percentage);
            countdownDisplay.textContent = totalSeconds <= 0 ? 0 : totalSeconds; // Display 0 when time is up

            // Update time grid colors
            updateTimeGridColors(totalSeconds, percentage);
        }

        function updateCountdownDisplayColor(display, percentage) {
            display.classList.remove('text-warning', 'text-danger', 'shaking');
            if (percentage > 0.5) {
                // Normal state
            } else if (percentage > 0.25) {
                display.classList.add('text-warning');
            } else if (percentage > 0.05) {
                display.classList.add('text-danger');
            } else {
                display.classList.add('text-danger', 'shaking');
            }
        }

        function updateTimeGridColors(totalSeconds, percentage) {
            let elapsedUnits;
            if (originalSeconds > 3600) {
                elapsedUnits = Math.ceil((originalSeconds - totalSeconds) / 8);
            } else if (originalSeconds > 1800) {
                elapsedUnits = Math.ceil((originalSeconds - totalSeconds) / 4);
            } else {
                elapsedUnits = originalSeconds - totalSeconds;
            }
            const gridState = [];
            const squares = document.querySelectorAll('.time-square');
            squares.forEach((square, index) => {
                if (index < elapsedUnits) {
                    // Turn passed time squares to gray
                    square.style.backgroundColor = '#444444';
                } else {
                    // Reset square classes for remaining time
                    square.className = 'time-square';
                    if (percentage > 0.5) {
                        // Optionally, you can add a specific class or style for this range
                    } else if (percentage > 0.25) {
                        square.classList.add('yellow');
                    } else {
                        square.classList.add('red');
                    }
                }
                gridState.push(square.style.backgroundColor);
            });
            localStorage.setItem('gridState', JSON.stringify(gridState))
        }
        
        // Ensure you also update the grid state in other relevant places, such as when the timer is reset
        document.getElementById('reset-button').addEventListener('click', function() {
            // ... existing code ...
            localStorage.removeItem('gridState'); // Remove grid state from local storage on reset
        });

        function toggleVisibility() {
            var inputGroup = document.getElementById('input-group');
            var countdownGroup = document.getElementById('countdown-group');
            
            if (inputGroup.style.display === 'none') {
                inputGroup.style.display = 'block';
                countdownGroup.style.display = 'none';
            } else {
                inputGroup.style.display = 'none';
                countdownGroup.style.display = 'block';
            }
        }

        function animateGrid() {
            const squares = document.querySelectorAll('.time-square');
            const interval = 1000; // Interval in milliseconds for the color change effect

            setInterval(() => {
                // Reset all squares to their original color
                squares.forEach(sq => sq.style.backgroundColor = '#444444'); // Corrected the color code

                // Randomly select squares and change their color
                for (let i = 0; i < squares.length; i++) {
                    if (Math.random() < 0.25) { // Adjust the probability as needed
                        // Generate a random color
                        const randomColor = '#' + Math.floor(Math.random()*16777215).toString(16);

                        // Apply color change
                        squares[i].style.transition = 'background-color 0.25s';
                        squares[i].style.backgroundColor = randomColor;
                    }
                }
            }, interval);
        }
 
    </script>

</body>
</html>
